## 통합 테스트 환경 구축의 필요성
`젠킨스 CI/CD 파이프라인`의 **`테스트 단계`** 를 성공적으로 완료하기 위해선 통합 테스트 환경 구축이 필요했습니다.
```bash
// 파이프라인 중 일부
stage('Test') {
    steps {
        dir('./') {
            sh './gradlew clean test'
        }
    }
}
```


현재 팀 Ludo 백엔드는 79개의 테스트가 존재하고, 이 중 **상당 수는 `Service Layer - Persistence Layer` 에 대한 통합 테스트**로 이루어져 있습니다.
기존에는 로컬 환경에서 테스트를 진행했기 때문에 별 다른 문제가 되지 않았습니다. 팀원 모두 로컬 환경에 테스트 환경(MySQL 도커 컨테이너) 을 구축해놨기 때문입니다.

<img src = "https://github.com/Ludo-SMP/ludo-backend_wiki/assets/68291395/43b1a598-77cb-4990-b33a-72113ec71f5d" width=40%>


하지만 `젠킨스 클라우드 인스턴스`에는 이러한 환경이 구축되어 있지 않기 때문에, 당연하게도 테스트 과정이 실패했고 개선이 필요했습니다.
<img src = "https://github.com/Ludo-SMP/ludo-backend_wiki/assets/68291395/813e4988-1ef6-448b-909a-e81d7dff521c" width=40%>

**※ 통합 테스트가 많았던 이유**
>도메인 영속성은 JPA로 관리하고 있습니다. 변경 감지, 지연 로딩 등 **JPA가 제공하는 메커니즘을 제대로 활용**해서 , **비즈니스 로직이 정상적으로 수행**되는 지 확인할 필요가 있다고 판단했습니다.
>
>통합 테스트 비중을 높임으로서 테스트 안정성은 향상시킬 수 있었지만, **테스트 관리 비용이 높아지는 트레이드 오프를 체감**했습니다.
>추 후 통합 테스트의 비중을 줄이고 단위 테스트의 비중을 높여서 **`테스트 안정성과 테스트 관리 비용`의 트레이드 오프를 적절한 선에서 타협**할 필요가 있겠습니다.

<br><br>

## 환경 설정 분리

### 프라이빗 깃 레포 서브 모듈 도입
**`통합 테스트 환경 구축`** 이전에, **`테스트`** 를 성공적으로 수행하기 위해선 환경 설정 분리가 선행돼야 했습니다.

기존에는 `.env` 파일을 활용하여 `.yaml` 파일을 구성했습니다. `.env` 파일에는 환경 변수들이 존재했기에, 깃으로 관리하지 않고 슬랙을 통해 팀원들과 동기화하며 관리했습니다. 이러다보니 **`매 번 동기화 해야 하는 관리 비용 문제`** 가 있었습니다. 또한 `젠킨스 인스턴스`에 `.env` 파일이 없기 때문에 테스트 빌드가 실패하여, **`젠킨스 테스트가 실패하는 문제`** 도 발생했습니다.

환경 변수 관리를 위한 대안책은 4 가지 정도로 정리할 수 있습니다. 자세한 내용은 [팀 Ludo 백엔드 이슈 탭](https://github.com/Ludo-SMP/ludo-backend/issues/54)에서 확인할 수 있습니다.

1. **.env 파일을 젠킨스 클라우드 인스턴스에서 관리**  
	`pros:` 쉽다  
	`cons:` 환경 변수 관리 비용 ↑ (로컬 .env와 동기화)

2. **쉘 스크립트로 환경 변수 설정**  
	`cons:` 환경 변수 관리 비용 ↑

3. **환경 설정 관리용 프라이빗 레포를 서브 모듈로 사용**  
	`pros:` 환경 변수 관리 비용 ↓ (동기화 필요 X)  
	`cons:` 초기 세팅, 약간의 러닝 커브

4. **AWS S3이나 GCP Cloud Storage와 bash를 사용**  
	`pros:` gcp 기준 합리적인 가격 (한달에 약 127원)  
	`cons:` 파일 스토리지를 사용할만큼 관리 데이터가 많지 않음

각각의 장.단점을 고려하여 **프라이빗 깃 레포**에 환경 변수들을 관리하고, 이를 **서브 모듈**로 사용하는 방안을 채택했습니다.


<br><br>


## 테스트 컨테이너 도입
### 도입 이유
젠킨스 환경에서 테스트를 성공시키기 위해 다양한 방안들을 고민했습니다.

#### 방안1. In-Memory H2 DB 사용
`pros:` 테스트 속도 ↑, 테스트 환경 관리 비용이 적음  
`cons:` DB 스펙 변경 (MySQL → H2)

인메모리 DB를 사용하는 방안도 충분히 괜찮은 선택지라고 생각합니다. 메모리 기반이기 때문에 테스트 속도가 비교적 빠르고, 이는 잦은 배포를 목표로 하는 CI/CD 와도 부합합니다.
또한 별도의 외부 모듈을 사용하지 않기 때문에, 테스트 환경 관리 비용이 적다는 점도 큰 장점입니다. 하지만 **애플리케이션의 모든 구성 요소가 예상대로 함께 작동하는지 확인** 하는 통합 테스트의 성격을 벗어난다고 생각했습니다.

<br>

#### 방안2. 테스트 DB용 클라우드 인스턴스 구축
`cons:` 환경 설정 관리 비용 ↑, 상황에 따라 테스트 독립성 ↓

별도의 외부 모듈이 추가되는 것은 환경 설정 관리 비용이 증가함을 시사하기도 합니다. 방화벽 정책 및 포트 설정을 해주어야 하며, MySQL 환경도 추가로 구축해줘야 합니다. 또한 외부 모듈의 IP를 코드 레벨에서 의존하는 등 관리 포인트가 많아집니다.

**상황에 따라 테스트 독립성을 보장하지 못할 가능성**이 있습니다. 젠킨스는 분산 아키텍처 구조로 테스트를 **병렬**로 실행시킬 수 있습니다. 동일한 테스트 DB 인스턴스를 대상으로 병렬로 테스트하는 과정에서 테스트 독립성을 보장하지 못할 수도 있다고 판단했습니다.

<img src = "https://github.com/Ludo-SMP/ludo-backend_wiki/assets/68291395/7f9df976-6b24-4c68-a876-78e287309cf9" width=45%>

<img src = "https://github.com/Ludo-SMP/ludo-backend_wiki/assets/68291395/447f7363-0cbb-4623-ba2a-fdd2d1fd63cd" width=45%>

<br>

#### 방안3. 테스트 컨테이너
`pros:` 테스트 독립성 ↑, 클라우드 환경에 적합
`cons:` 러닝 커브, 젠킨스 인스턴스 스펙 (cpu 1, mem 3gb)에 대한 점검 필요
